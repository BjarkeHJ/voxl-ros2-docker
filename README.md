# VOXL-ROS2-DOCKER: Cross-Platform Docker Environement
### Introduction
Cross-platform Docker environment for developing ROS2 Humble applications on the ModalAI VOXL2 drone platform. \
The VOXL2 Companion Computer is an ARM64 platform running Ubuntu 18.04. \
This setup provides a Ubuntu 22.04 + ROS2 Humble workspace via Docker. \
Through emulated compilation if offers tooling for developing on an x86_64 workstation and deploying pre-built ARM64 binaries to the drone.

Key features:
- Multi-stage Dockerfile — full dev image for the workstation, slim runtime image for the drone
- Emulated-compilation via QEMU — build ARM64 binaries on your x86 workstation with zero toolchain configuration
- One-command deploy — rsync source and pre-built packages to the drone over SSH

### Requirements (Tested)
- Workstation (x86_64)
  - Ubuntu $\ge$ 18.04
  - Docker Engine Version $\ge$ 20.10
- Voxl2 (aarch64)
  - Ubuntu $\ge$ 18.04
  - Docker Engine Version $\ge$ 20.10

<details>
<summary> Docker Engine Installation </summary>

This guide covers the apt installation of Docker Engine require to build and run docker images and containers on Ubuntu systems \
Source: https://docs.docker.com/engine/install/ubuntu/

### Install Docker Engine
Do this both on workstation and Voxl2 Companion Computer

1. Set up Docker's apt repository:
```
# Add Docker's official GPG key:
sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF

sudo apt update
```

2. Install the Docker packages
```
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

3. Verify Installation
```
sudo docker run hello-world
```
</details>

### Project Directory Structure
```
voxl-ros2-docker/                           This repo lives on your workstation
├── .devcontainer/
│   └── devcontainer.json                   VS Code Dev Containers config
├── .env                                    Drone SSH settings, ROS_DOMAIN_ID
├── docker/
│   ├── .dockerignore
│   ├── Dockerfile                          Multi-stage: voxl-dev + voxl-runtime
│   ├── docker-compose.workstation.yml      For workstation (dev + cross-arm64)
│   └── docker-compose.drone.yml            For drone (runtime only)
├── scripts/
│   └── build.sh                            All build / deploy / drone commands
├── ros2_ws/                                ROS2 Workspace
│   └── src/
        └── ros2_pkg/
├── deploy/                                 Auto-generated by build.sh (deploy staging area)
│   ├── docker-compose.yml
│   ├── src/
│   └── install/
└── README.md
```

### Onboard Docker Directory
Note: In this case user is root
```
/voxl_docker/
├── docker-compose.yml              Compose file for the runtime container
├── src/                            Your ROS2 packages (for launch files, Python nodes)
└── install
```

### Complete Setup and Workflow



### Build commands (scripts/build.sh)
```
---- HELP ----
  help                 Display all commands

---- ONE-TIME SETUP ----
  setup-qemu           Install QEMU user-static for arm64 emulation (run once)

---- BUILD IMAGES ----
  build-deps           Build only the dependency base stage (useful to verify deps)
  build-dev            Build the full dev image (native x86_64)
  build-cross          Build the full dev image for arm64 via QEMU
  build-runtime        Build the slim runtime image for arm64

---- DEVELOPMENT (workstation) ----
  dev                  Open a shell in the native x86 dev container
  cross                Open a shell in the arm64 QEMU dev container
  build-ws             Run colcon build in the native dev container
  build-ws-cross       Run colcon build in the arm64 container (produces arm64 binaries)

---- DEPLOY TO DRONE ----
  export-runtime       Save the slim runtime image to a .tar.gz file
  extract-install      Copy cross-built arm64 install/ out of the Docker volume
  deploy               Rsync source + install + compose to drone
  deploy-image         Transfer the runtime image .tar.gz to drone and load it

---- DRONE OPERATIONS (via SSH) ----
  voxl-start          Start the voxl-drone container
  voxl-shell          Attach to the running voxl-drone container
  voxl-logs           Show voxl-drone container logs
  voxl-stop           Stop the voxl-drone container
```

### Tips n' Tricks

<details>
<summary> SSH Keygen </summary>

To avoid rewriting password when SSHing into the drone, it is recommended to setup a SSH key. \
In the following replace root with system user and ip with drone ip address. 
```
# On workstation
ssh-keygen -t ed25519

# Copy it to the drone
ssh-copy-id root@ip
```
</details>


